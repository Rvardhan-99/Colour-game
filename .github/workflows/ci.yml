name: Deploy Flask App to Server

on:
  push:
    branches:
      - main

jobs:
  deploy:
    name: Deploy Flask App
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3

      - name: Deploy via SSH to Remote Server
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
                    echo "ðŸ”§ Starting deployment..."
                  
                    APP_DIR=~/apps/your-flask-app
                  
                    echo "ðŸ“ Cleaning and setting up app directory..."
                    rm -rf $APP_DIR
                    mkdir -p $APP_DIR
                    cd $APP_DIR
                  
                    echo "ðŸ“¥ Cloning latest code from GitHub..."
                    git clone https://github.com/Rvardhan-99/Colour-game.git temp
                    mv temp/* . || true
                    mv temp/.* . || true
                    rm -rf temp
                  
                    echo "ðŸ Setting up virtual environment..."
                    python3 -m venv venv
                    $APP_DIR/venv/bin/pip install --upgrade pip
                    $APP_DIR/venv/bin/pip install -r requirements.txt
                  
                    echo "ðŸ›‘ Killing any running instance of app.py..."
                    pkill -f app.py || true
                  
                    echo "ðŸš€ Starting Flask app in background..."
                    $APP_DIR/venv/bin/python3 $APP_DIR/app.py --host=0.0.0.0 --port=5000 > $APP_DIR/app.log 2>&1 &
                    disown
                  
                    echo "âœ… Deployment complete. App should be running at http://<server-ip>:5000"
