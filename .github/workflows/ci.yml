name: Deploy Flask App to Server

on:
  push:
    branches:
      - main

jobs:
  deploy:
    name: Deploy Flask App
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3

      - name: Deploy via SSH to Remote Server
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            echo "🔧 Starting deployment..."

            # Define project path
            APP_DIR=~/apps/your-flask-app

            echo "📁 Cleaning and setting up app directory..."
            rm -rf $APP_DIR
            mkdir -p $APP_DIR
            cd $APP_DIR

            echo "📥 Cloning latest code from GitHub..."
            git clone https://github.com/Rvardhan-99/Colour-game.git temp
            mv temp/* . || true
            mv temp/.* . || true
            rm -rf temp

            echo "🐍 Setting up virtual environment..."
            python3 -m venv venv
            source venv/bin/activate
            pip install --upgrade pip
            pip install -r requirements.txt

            echo "🛑 Stopping any existing Flask app..."
            pkill -f app.py || true

            echo "🚀 Starting Flask app with nohup on 0.0.0.0:5000..."
            nohup python3 app.py --host=0.0.0.0 --port=5000 > app.log 2>&1 &

            echo "✅ Deployment complete. App should now be running on port 5000."
